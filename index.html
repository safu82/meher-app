
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meher Study App — Plain Demo with UNDO (v0.7.4)</title>
  <style>
    :root{
      --bg:#F8FAFC; --text:#334155; --muted:#475569; --border:#E5E7EB; --secondary:#94A3B8;
      --success-bg:#DCFCE7; --success-text:#166534;
      --warn-bg:#FEF3C7; --warn-text:#92400E;
      --info-bg:#E0F2FE; --info-text:#075985;
      --white:#FFFFFF; --chip:#A7F3D0;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);}
    .container{max-width:960px;margin:0 auto;padding:24px;}
    .row{display:flex;gap:8px;align-items:center;}
    .tabs{display:flex;gap:8px;margin-bottom:16px;}
    .tab{padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer;font-size:14px;}
    .tab.inactive{background:transparent;}
    h2{font-size:14px;color:var(--muted);margin:0 0 8px 0;}
    .section{margin-bottom:20px;}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:12px;margin-bottom:10px;box-shadow:0 1px 2px rgba(0,0,0,0.04);}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .chip.success{background:var(--success-bg);color:var(--success-text)}
    .chip.warn{background:var(--warn-bg);color:var(--warn-text)}
    .chip.info{background:var(--info-bg);color:var(--info-text)}
    .btn{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--text);font-size:13px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:default}
    .input, select{padding:8px 10px;border:1px solid var(--border);border-radius:12px;font-size:14px;background:#fff;color:var(--text)}
    .grid{display:grid;gap:10px}
    .grid3{grid-template-columns:1fr 1fr 1fr}
    .muted{color:var(--muted);font-size:12px}
    .bar{height:10px;border:1px solid var(--border);border-radius:999px;background:#fff;overflow:hidden}
    .bar>div{height:100%;background:var(--chip)}
    .pill{font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .row-space{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .emoji{font-size:18px;margin-right:6px}
    .subject-pastel{padding:2px 6px;border-radius:6px}
    .ring{display:flex;align-items:center;gap:12px}
    #error-panel{display:none;background:#FEE2E2;color:#7F1D1D;padding:12px;border-radius:12px;margin-bottom:10px;white-space:pre-wrap}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .box{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;max-width:420px;width:100%}
  
/* --- Cheerful accent + donut ring --- */
:root{ --accent:#6B8AFD; --ring-track:#E5E7EB; }
.c-ring{
  --size: 92px; --p:0;
  width:var(--size); height:var(--size); border-radius:50%;
  background:
    conic-gradient(var(--accent) calc(var(--p)*1%), var(--ring-track) 0),
    radial-gradient(farthest-side, #fff 72%, transparent 73%);
  display:grid; place-items:center;
}
.c-ring > .c-label{ font-weight:600; font-size:12px; color:var(--muted); text-align:center; line-height:1.2 }
.c-ring-wrap{ display:flex; gap:12px; align-items:center; }

/* --- Subject pastels for Summary rows --- */
:root{
  --sub-eng-lang:#E8EDFF;
  --sub-eng-lit:#F0E7FF;
  --sub-french:#FFE8F0;
  --sub-history:#FFEFD6;
  --sub-math:#DFF7E5;
  --sub-chem:#E6FAF2;
  --sub-bio:#EAF5E9;
  --sub-ict:#E6F5FF;
}
.card.sub-eng-lang{ border-left:6px solid var(--sub-eng-lang); }
.card.sub-eng-lit{ border-left:6px solid var(--sub-eng-lit); }
.card.sub-french{ border-left:6px solid var(--sub-french); }
.card.sub-history{ border-left:6px solid var(--sub-history); }
.card.sub-math{ border-left:6px solid var(--sub-math); }
.card.sub-chem{ border-left:6px solid var(--sub-chem); }
.card.sub-bio{ border-left:6px solid var(--sub-bio); }
.card.sub-ict{ border-left:6px solid var(--sub-ict); }

/* --- Mobile responsiveness pass (stack, wrap, larger taps) --- */

/* 720px and down: tablet/large phones */
@media (max-width: 720px) {
  .container { padding: 16px; }

  /* Tabs become horizontally scrollable chips */
  .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .tab { flex: 0 0 auto; }

  /* Let action rows wrap instead of squishing */
  .row, .row-space { flex-wrap: wrap; }

  /* Grid of 3 → responsive auto-fit */
  .grid3 { 
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
  }

  /* Cards: give a bit more internal spacing for fingers */
  .card { padding: 14px; }

  /* Inputs and selects fill available width */
  .input, select { width: 100%; }

  /* Buttons inside cards: stack nicely */
  .card .row .btn { margin-bottom: 6px; }
}

/* 480px and down: phones */
@media (max-width: 480px) {
  /* Reduce global font crowding a touch */
  body { font-size: 15px; }

  /* Make buttons comfy (44px+ targets) */
  .btn { 
    width: 100%;
    padding: 10px 12px; 
    text-align: center;
  }

  /* Time pickers & selects stack under labels */
  label .input, label select { width: 100%; }

  /* Session meta moves to two rows for readability */
  .card .row-space { gap: 10px; }

  /* Progress bar stays visible and clear */
  .bar { height: 12px; }

  /* Donut ring container (if/when visible) centers and shrinks a bit */
  .c-ring { --size: 80px; }
}

/* Very small devices (360px and down) */
@media (max-width: 360px) {
  .container { padding: 12px; }
  .tab { padding: 6px 10px; font-size: 13px; }
  .pill { font-size: 11px; }
}

/* Modal: full-width sheet on mobile */
@media (max-width: 720px) {
  .modal .box {
    max-width: 100%;
    width: 100%;
    border-radius: 12px 12px 0 0;
    margin-top: auto;
  }
}

</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Early globals so UI can safely read them before we initialize Supabase later.
  window.SHOW_CLOUD   = true; // show Cloud panel unless overridden later
  window.SUPABASE_URL  = localStorage.getItem('supa_url')  || "";
  window.SUPABASE_ANON = localStorage.getItem('supa_anon') || "";
  window.SUPA_USER_ID  = localStorage.getItem('supa_user_id') || "";
  window.sb = null; // will be set in supaReady()

  window.addEventListener('error', function(e){
    try{
      var box = document.getElementById('error-panel');
      if(box){
        box.style.display='block';
        box.textContent = 'Error: ' + (e.message || e.toString());
      }
    }catch(_){}
  });
  window.addEventListener('unhandledrejection', function(e){
    try{
      var box = document.getElementById('error-panel');
      if(box){
        box.style.display='block';
        var msg = (e.reason && (e.reason.message || e.reason.toString())) || ''+e;
        box.textContent = 'Error: ' + msg;
      }
    }catch(_){}
  });
</script>


  <!-- Meher Progress Card (dual rings) -->
  <style>
    /* Hide legacy donut charts above sessions/daily totals */
    .c-ring-wrap{ display:none !important; }

    .msa-card{display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;margin:12px 0;border:1px solid #eef2f7;border-radius:16px;
      background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04);}
    .msa-left-rings{display:flex;gap:16px;align-items:center;}
    .msa-ring-wrap{position:relative;width:132px;height:132px;}
    .msa-ring{transform:rotate(-90deg);} .msa-ring circle{fill:none;stroke-linecap:round;}
    .msa-ring .bg{stroke:#e9edf3;stroke-width:10;} .msa-ring .fg{stroke-width:10;transition:stroke-dashoffset .6s ease;}
    .msa-ring-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .msa-ring-center .big{font-size:18px;font-weight:700;color:#111827;line-height:1;}
    .msa-ring-center .small{font-size:12px;color:#6b7280;margin-top:2px;}
    .msa-right{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1;}
    .msa-right .label{font-weight:600;color:#111827;}
    .msa-linear{width:100%;height:8px;background:#eef2f7;border-radius:999px;overflow:hidden;}
    .msa-linear>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#93c5fd,#86efac);transition:width .6s;}
    .msa-legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .msa-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;
      background:#f8fafc;border:1px solid #e5e7eb;color:#0f172a;}
    .msa-chip .emo{font-size:14px;}
  </style>

</head>
<body>
  <div class="container">
    <div id="error-panel"></div>
    <div class="row-space" style="margin-bottom:16px">
      <div class="row">
        <div class="emoji" aria-hidden="true">🔥</div>
        <div class="muted">Streak: (coming soon)</div>
        <div class="muted">•</div>
        <div class="muted" id="week-chip">This Week: 0 / 32h</div>
      </div>
      <div class="muted">☰</div>
    </div>

    <div class="tabs">
      <button class="tab" id="tab-today">Today</button>
      <button class="tab inactive" id="tab-plan">Plan</button>
      <button class="tab inactive" id="tab-summary">Summary</button>
    </div>

    <div id="screen-today"></div>
    <div id="screen-plan" style="display:none"></div>
    <div id="screen-summary" style="display:none"></div>
  </div>

  <!-- Modal for rescheduling -->
  <div class="modal" id="res-modal">
    <div class="box">
      <div class="row-space">
        <div style="font-weight:700"><span id="res-title">Reschedule Tuition</span></div>
        <button class="btn" id="res-x">✕</button>
      </div>
      <div class="grid" style="margin-top:8px">
        <label class="muted">Date
          <input class="input" type="date" id="res-date"/>
        </label>
        <label class="muted" id="res-subj-wrap" style="display:none">Subject
          <select class="input" id="res-subject"></select>
        </label>

        <div class="row" style="gap:6px">
          <label class="muted">Start
            <input class="input" type="time" id="res-start"/>
          </label>
          <label class="muted">End
            <input class="input" type="time" id="res-end"/>
          </label>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;gap:8px">
        <button class="btn" id="res-cancel">Cancel</button>
        <button class="btn" id="res-save">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Error panel
    window.addEventListener('error', function(e){
      var box = document.getElementById('error-panel');
      box.style.display='block';
      box.textContent = 'Error: ' + e.message + (e.error && e.error.stack ? '\n' + e.error.stack : '');
    });

    // --- Data & utils ---
    var SUBJECTS=[
      {id:"eng-lang",name:"English Language",emoji:"📘",color:"#E8EDFF"},
      {id:"eng-lit",name:"English Literature",emoji:"📖",color:"#F0E7FF"},
      {id:"french",name:"French",emoji:"🇫🇷",color:"#FFE8F0"},
      {id:"history",name:"History",emoji:"🏛️",color:"#FFEFD6"},
      {id:"math",name:"Math",emoji:"🔢",color:"#DFF7E5"},
      {id:"chem",name:"Chemistry",emoji:"⚗️",color:"#E6FAF2"},
      {id:"bio",name:"Biology",emoji:"🧬",color:"#EAF5E9"},
      {id:"ict",name:"ICT",emoji:"💻",color:"#E6F5FF"},
    ];
    var SUBJECT_MAP = {}; SUBJECTS.forEach(function(s){ SUBJECT_MAP[s.id]=s; });
    var TEMPLATES=[
      {day:1,subjectId:"bio",start:"19:00",end:"20:00"},
      {day:2,subjectId:"ict",start:"16:00",end:"17:00"},
      {day:2,subjectId:"bio",start:"19:00",end:"20:00"},
      {day:3,subjectId:"ict",start:"16:00",end:"17:00"},
      {day:3,subjectId:"french",start:"17:00",end:"18:00"},
      {day:4,subjectId:"chem",start:"16:45",end:"18:00"},
      {day:5,subjectId:"french",start:"17:00",end:"18:00"},
      {day:5,subjectId:"math",start:"19:30",end:"20:30"},
      {day:0,subjectId:"math",start:"13:30",end:"14:30"},
      {day:0,subjectId:"chem",start:"18:30",end:"19:30"},
    ];
    var STORAGE_KEY="msa_v074_plain_undo";

    function z2(n){ return n<10?("0"+n):(""+n); }
    function toIso(d){
      if(!(d instanceof Date)) d = new Date(d);
      return d.getFullYear()+"-"+z2(d.getMonth()+1)+"-"+z2(d.getDate());
    }
    function parseM(t){
      var parts = (""+t).split(":"); var h=parseInt(parts[0]||"0",10), m=parseInt(parts[1]||"0",10);
      return h*60+m;
    }
    function toTime(m){ var h=Math.floor(m/60), mm=m%60; return z2(h)+":"+z2(mm); }
    function dur(s,e){ return Math.max(0, parseM(e)-parseM(s)); }
    function addDays(d,n){ var nd=new Date(d); nd.setDate(nd.getDate()+n); return nd; }
    function isWend(d){ var dd=(d instanceof Date?d:new Date(d)); var g=dd.getDay(); return g===0||g===6; }
    function targetH(d){ return isWend(d)?6:4; }
    function weekMon(d){ var nd=new Date(d); var g=nd.getDay(); var diff=(g+6)%7; nd.setDate(nd.getDate()-diff); nd.setHours(0,0,0,0); return nd; }

    function load(){
      try{
        var raw = localStorage.getItem(STORAGE_KEY);
        return raw? JSON.parse(raw) : {days:{},settings:{tz:"Asia/Kolkata"},undo:{}};
      }catch(e){ return {days:{},settings:{tz:"Asia/Kolkata"},undo:{}}; }
    }
    function save(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
// --- backup helpers (export only) ---
function downloadText(filename, text){
  var a = document.createElement('a');
  a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
  a.download = filename;
  a.click();
}
function exportState(){
  try{
    var json = JSON.stringify(state, null, 2);
    var stamp = new Date().toISOString().slice(0,10); // e.g., 2025-08-30
    downloadText('meher-backup-' + stamp + '.json', json);
  }catch(e){
    alert('Export failed: ' + e.message);
  }
}


    var state = load();

    // push snapshot and apply change
    function upsertDay(iso, fn){
      var base = state.days[iso] || {tuition:[],plan:[],actuals:[]};
      // init undo stack
      state.undo = state.undo || {};
      var stack = state.undo[iso] || [];
      stack.push(JSON.parse(JSON.stringify(base)));
      if(stack.length>20) stack = stack.slice(stack.length-20);
      state.undo[iso] = stack;

      // apply mutation
      var d = JSON.parse(JSON.stringify(base));
      fn(d);
      state.days[iso] = d;
      save(state);
    }
    function hasUndo(iso){
      return !!(state.undo && state.undo[iso] && state.undo[iso].length);
    }
    function undoDay(iso){
      if(!hasUndo(iso)) return;
      var stack = state.undo[iso];
      var snap = stack.pop();
      state.undo[iso] = stack;
      state.days[iso] = snap;
      save(state);
    }

    function seed(date){
      var iso = toIso(date), dow = (new Date(date)).getDay();
      var day = state.days[iso];
      if(!day || !day.tuition || day.tuition.length===0){
        var templ = TEMPLATES.filter(function(t){return t.day===dow;}).map(function(t){
          return {id:cryptoUUID(),subjectId:t.subjectId,start:t.start,end:t.end,status:"pending"};
        });
        if(templ.length){
          state.days[iso] = (state.days[iso] || {plan:[],actuals:[]});
          state.days[iso].tuition = templ;
          save(state);
        }
      }
    }

    function cryptoUUID(){
      // simple fallback UUID
      var s4 = function(){ return Math.floor((1+Math.random())*0x10000).toString(16).substring(1); };
      return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4();
    }

    // --- Rendering helpers ---
    function el(tag, attrs, children){
      var e = document.createElement(tag);
      if(attrs){
        Object.keys(attrs).forEach(function(k){
          if(k==="class") e.className = attrs[k];
          else if(k==="style") e.setAttribute("style", attrs[k]);
          else if(k==="disabled"){
            if(attrs[k]) e.setAttribute("disabled","");
          }
          else if(k.startsWith("on") && typeof attrs[k]==="function") e.addEventListener(k.substring(2), attrs[k]);
          else e.setAttribute(k, attrs[k]);
        });
      }
      if(children!=null){
        if(Array.isArray(children)) children.forEach(function(c){ if(c==null) return; if(typeof c==="string") e.appendChild(document.createTextNode(c)); else e.appendChild(c); });
        else if(typeof children==="string") e.textContent = children;
        else e.appendChild(children);
      }
      return e;
    }

    function subjectLabel(id){
      var s = SUBJECT_MAP[id] || {name:id, emoji:""};
      return s.emoji+" "+s.name;
    }

    function weekHoursTotal(date){
      var ws = weekMon(date);
      var sum = 0;
      for(var i=0;i<7;i++){
        var iso = toIso(addDays(ws,i));
        var day = state.days[iso];
        if(day && day.actuals){
          var mins = day.actuals.reduce(function(a,x){ return a+(x.duration||0); }, 0);
          sum += mins/60;
        }
      }
      return sum;
    }

    function refreshWeekChip(){
      var chip = document.getElementById("week-chip");
      chip.textContent = "This Week: "+weekHoursTotal(new Date()).toFixed(1)+" / 32h";
    }

    // --- Screens ---
    var todayDate = new Date();
    var planDate = addDays(new Date(), 1);
    var summaryWeek = weekMon(new Date());

    function renderTabs(active){
      document.getElementById("tab-today").classList.toggle("inactive", active!=="today");
      document.getElementById("tab-plan").classList.toggle("inactive", active!=="plan");
      document.getElementById("tab-summary").classList.toggle("inactive", active!=="summary");
      document.getElementById("screen-today").style.display = active==="today"?"block":"none";
      document.getElementById("screen-plan").style.display = active==="plan"?"block":"none";
      document.getElementById("screen-summary").style.display = active==="summary"?"block":"none";
      refreshWeekChip();
    }

    // Today Screen
    function renderToday(){
      seed(todayDate);
      var iso = toIso(todayDate);
      var day = state.days[iso] || {tuition:[],plan:[],actuals:[]};
      var goal = targetH(todayDate);
      var doneMins = (day.actuals||[]).reduce(function(a,x){return a+(x.duration||0);},0);
      var doneH = doneMins/60;

      var root = document.getElementById("screen-today");
      root.innerHTML = "";

      // Progress with UNDO on right
      var header = el("div",{class:"row-space"},[
        el("h2", null, "Progress — " + new Date(toIso(todayDate)+"T00:00:00").toLocaleDateString(undefined, { weekday:"long", day:"numeric", month:"long", year:"numeric" })),
        el("div",{class:"row"},[
          el("span",{class:"muted"},"This Week: "+weekHoursTotal(new Date()).toFixed(1)+" / 32h"),
          el("button",{class:"btn", disabled:!hasUndo(iso), onclick:function(){ undoDay(iso); renderAll(); }}, "⟲ Undo")
        ])
      ]);
      var bar = el("div",{class:"bar"},[ el("div",{style:"width:"+Math.min(100, Math.round((doneH/goal)*100))+"%"}) ]);
      root.appendChild(el("div",{class:"section"},[
        header,
        el("div",{class:"ring"},[
          el("div",{class:"pill"} , doneH.toFixed(1)+" / "+goal.toFixed(1)+"h"),
          bar
        ]),
        doneH<goal? el("div",{class:"muted",style:"margin-top:8px;color:var(--warn-text)"}, "Short by "+(goal-doneH).toFixed(1)+"h — add extra study?") : null
      ]));
      // Today donut ring (done vs goal)
      try{
        var pctT = Math.max(0, Math.min(100, Math.round((doneH/goal)*100)));
        var ringT = el("div",{class:"c-ring", style:"--p:"+pctT},[ el("div",{class:"c-label"}, (doneH.toFixed(1)+" / "+goal.toFixed(1)+"h")) ]);
        var secTR = el("div",{class:"section"},[
          el("div",{class:"c-ring-wrap"},[ ringT, el("div",null,[
            el("div",{class:"muted"},"Today progress"),
            el("div",null, pctT+"%")
          ]) ])
        ]);
        root.appendChild(secTR);
      }catch(_){}


      // Sessions (tuitions not cancelled + self-study plan)
      var sessions = [];
      (day.tuition||[]).forEach(function(t,idx){
        if(t.status==="cancelled") return;
        if(!((day.actuals||[]).some(function(a){return a.type==="tuition" && a.subjectId===t.subjectId && a.startActual===t.start && a.endActual===t.end;}))) {sessions.push({type:"tuition", idx:idx, subjectId:t.subjectId, start:t.start, end:t.end, status:t.status});}
      });
      (day.plan||[]).forEach(function(p,idx){ if(p && p.isExtra && p.cancelled) return;
        if(!((day.actuals||[]).some(function(a){return a.sessionPlanId===p.id;}))) {sessions.push({type:"self", pidx:idx, subjectId:p.subjectId, start:p.start, end:p.end, topic:p.topic, planId:p.id});}
      });
      sessions.sort(function(a,b){ return parseM(a.start)-parseM(b.start); });

      var secSess = el("div",{class:"section"},[ el("h2",null,"Today’s Sessions") ]);
      if(sessions.length===0){
        secSess.appendChild(el("div",{class:"muted"},"No sessions for today yet."));
      }else{
        sessions.forEach(function(s){
          if(s.type==="tuition"){
            var t = day.tuition[s.idx];
            var chipClass = t.status==="confirmed"?"success":t.status==="rescheduled"?"info":t.status==="cancelled"?"warn":"warn";
            var chipText = t.status==="confirmed"?"Confirmed ✓":t.status==="rescheduled"?"Rescheduled ↺":t.status==="cancelled"?"Cancelled":"Pending";
            var disabled = !!t.completed || (day.actuals||[]).some(function(a){
              return a.type==="tuition" && a.subjectId===s.subjectId && a.startActual===s.start && a.endActual===s.end;
            });
            var card = el("div",{class:"card"},[
              el("div",{class:"row-space"},[
                el("div",null, [ el("div",null, subjectLabel(s.subjectId)+" — Tuition"), el("div",{class:"muted"}, s.start+"–"+s.end) ]),
                el("span",{class:"chip "+chipClass}, chipText)
              ]),
              el("div",{class:"row",style:"margin-top:8px"},[
                el("button",{class:"btn", disabled:disabled, onclick:function(){ markDoneTodayTuition(s); }}, "□ Done"),
                (t.status!=="confirmed")? el("button",{class:"btn", onclick:function(){ setTuitionStatus(iso,s.idx,"confirmed"); }}, "✓ Confirm") : null,
                (t.status!=="cancelled")? el("button",{class:"btn", onclick:function(){ openResModal(iso,s.idx,t.start,t.end); }}, "↺ Reschedule") : null,
                el("button",{class:"btn", onclick:function(){ setTuitionStatus(iso,s.idx,"cancelled"); }}, "✗ Cancel")
              ])
            ]);
  // warnings (tuition)
  (function(){
    var w = buildWarning(iso, s.start, s.end);
    if(w) card.appendChild(el("div",{class:"muted"}, w));
  })();

                          card.className += " sub-"+s.subjectId;
secSess.appendChild(card);
          }else{
            var p = day.plan[s.pidx];
            var disabled = (day.actuals||[]).some(function(a){return a.sessionPlanId===p.id;}) || p.completed;
            var cardS = el("div",{class:"card"},[
              el("div",{class:"row-space"},[
                el("div",null, [ el("div",null, subjectLabel(s.subjectId)+" — Self-Study"+(s.topic?(" · "+s.topic):"")), el("div",{class:"muted"}, s.start+"–"+s.end) ]),
              ]),
              el("div",{class:"row",style:"margin-top:8px"},[el("button",{class:"btn", disabled:disabled, onclick:function(){ markDoneTodaySelf(s); }}, "□ Done"),(p && p.isExtra)? el("button",{class:"btn", onclick:function(){ openExtraEditModal(iso, p.id, p.start, p.end); }}, "✎ Edit time") : null,(p && p.isExtra)? el("button",{class:"btn", onclick:function(){ cancelExtra(iso, p.id); }}, "✗ Cancel") : null])
            ]);
// extra controls row (add-only; does not replace existing "Done" row)
cardS.appendChild(
  el("div",{class:"row",style:"margin-top:8px"},[
    el("button",{class:"btn", onclick:function(){ adjustPlanDuration(iso, p.id, -15); }}, "-15"),
    el("button",{class:"btn", onclick:function(){ adjustPlanDuration(iso, p.id, +15); }}, "+15"),
    el("button",{class:"btn", onclick:function(){ adjustPlanDuration(iso, p.id, +30); }}, "+30"),
    el("button",{class:"btn", onclick:function(){ movePlanToTomorrow(iso, p.id); }}, "→ Tomorrow")
  ])
);
  // warnings (self-study)
  (function(){
    var w = buildWarning(iso, s.start, s.end);
    if(w) cardS.appendChild(el("div",{class:"muted"}, w));
  })();

// Swap subject (quick dropdown) — add-only
(function(){
  var row = el("div",{class:"row",style:"margin-top:8px;align-items:center;gap:8px"},[
    el("div",{class:"muted"}, "Swap subject"),
    (function(){
      var sel = el("select",{class:"input", style:"min-width:160px"});
      (SUBJECTS||[]).forEach(function(su){
        var opt = document.createElement("option");
        opt.value = su.id;
        opt.textContent = su.name;
        if(su.id === p.subjectId) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.onchange = function(){
        // update subjectId for this plan item, then re-render
        upsertDay(iso, function(d){
          var q = (d.plan||[]).find(function(pp){ return pp.id === p.id; });
          if(q){ q.subjectId = sel.value; }
        });
        renderAll();
      };
      return sel;
    })()
  ]);
  cardS.appendChild(row);
})();

                          cardS.className += " sub-"+s.subjectId;
secSess.appendChild(cardS);
          }
        });
      }
      root.appendChild(secSess);

      // Add Extra (today)
      var secExtra = el("div",{class:"section"},[ el("h2",null,"Add Extra Study (Today)") ]);
      var sel = el("select",{id:"extra-subj"}, SUBJECTS.map(function(s){ return el("option",{value:s.id}, s.name); }));
      var topic = el("input",{class:"input",id:"extra-topic",placeholder:"Topic (optional)"});
      var startI = el("input",{class:"input",id:"extra-start",type:"time"});
      var endI = el("input",{class:"input",id:"extra-end",type:"time"});
      var addBtn = el("button",{class:"btn",onclick:function(){ addExtraToday(); }}, "Add");
      var row = el("div",{class:"grid grid3"},[ sel, topic, el("div",{class:"row"},[startI, el("div",{class:"muted"},"–"), endI, addBtn]) ]);
      secExtra.appendChild(row);
      root.appendChild(secExtra);

      // Today Log
      var secLog = el("div",{class:"section"},[ el("h2",null,"Today Log (completed)") ]);
// copy log button (WhatsApp-ready)
secLog.appendChild(
  el("div",{class:"row",style:"gap:8px;margin:8px 0"},[
    el("button",{class:"btn",onclick:function(){
      var day = state.days[toIso(todayDate)] || {actuals:[]};
      var lines = (day.actuals||[]).map(function(a){
        var label = subjectLabel(a.subjectId) + (a.topic? (" — "+a.topic):"");
        var time  = (a.startActual||a.start||"") + "–" + (a.endActual||a.end||"");
        var mins  = Math.round(a.duration||0) + "m";
        var tag   = (a.type==="tuition") ? " · Tuition" : "";
        return label + " — " + time + " (" + mins + ")" + tag;
      });
      var txt = lines.length ? lines.join("\n") : "Nothing logged today.";
      (navigator.clipboard && navigator.clipboard.writeText ?
        navigator.clipboard.writeText(txt).then(()=>alert("Copied")) : Promise.reject()
      ).catch(function(){ alert(txt); }); // fallback: show text if clipboard blocked
    }}, "Copy log")
  ])
);

      if((day.actuals||[]).length===0){
        secLog.appendChild(el("div",{class:"muted"},"Nothing logged yet."));
      }else{
        (day.actuals||[]).forEach(function(a){
          var card = el("div",{class:"card row-space"},[
            el("div",{class:"muted"}, (SUBJECT_MAP[a.subjectId]?SUBJECT_MAP[a.subjectId].name:a.subjectId)+" · "+a.startActual+"–"+a.endActual+" ("+Math.round(a.duration)+"m)"+(a.type==='tuition'?" · Tuition":"")),
            el("button",{class:"btn",onclick:function(){ removeActual(iso,a.id); renderAll(); }}, "🗑 Remove")
          ]);
          secLog.appendChild(card);
        });
      }
      root.appendChild(secLog);
    }

 
function markDoneTodayTuition(s){
  var iso = toIso(todayDate);

  upsertDay(iso, function(d){
    var already = (d.actuals||[]).some(function(a){
      return a.type==='tuition' && a.subjectId===s.subjectId && a.startActual===s.start && a.endActual===s.end;
    });
    if(already) return;

    var mins = dur(s.start,s.end);
    d.actuals = (d.actuals||[]);
    d.actuals.push({
      id: cryptoUUID(),
      sessionPlanId: null,
      subjectId: s.subjectId,
      type: "tuition",
      startActual: s.start,
      endActual: s.end,
      duration: mins
    });
    var t = d.tuition[s.idx]; if(t) t.completed = true;
  });

  // also write to DB (non-blocking)
  try {
    if (window.logActual) {
      window.logActual({
        subjectId: s.subjectId,
        startMin: parseM(s.start),
        endMin:   parseM(s.end)
      }).catch(console.warn);
    }
  } catch(_) {}

  renderAll();
}



    function markDoneTodaySelf(s){
  var iso = toIso(todayDate);
  var justLogged = null;

  upsertDay(iso, function(d){
    var p = d.plan.find(function(x){ return x.id === s.planId; });
    if(!p) return;
    var already = (d.actuals||[]).some(function(a){ return a.sessionPlanId === p.id; });
    if(already) return;

    var mins = dur(p.start, p.end);
    d.actuals = (d.actuals||[]);
    justLogged = {
      id: cryptoUUID(),
      sessionPlanId: p.id,
      subjectId: p.subjectId,
      type: "self",
      startActual: p.start,
      endActual: p.end,
      duration: mins
    };
    d.actuals.push(justLogged);
    p.completed = true;
  });

  // 🔗 NEW: also write this session to the database (non-blocking)
  try {
    if (window.logActual) {
      // prefer exact times; include plan_id/topic for nicer audits
      window.logActual({
        subjectId: justLogged ? justLogged.subjectId : (s && s.subjectId),
        startMin: parseM(justLogged ? justLogged.startActual : "00:00"),
        endMin:   parseM(justLogged ? justLogged.endActual   : "00:00"),
        planId:   s && s.planId,
        topic:    (function(){
          // best-effort pick up the topic from current plan item
          try {
            var d = state.days[iso] || {plan:[]};
            var p = (d.plan||[]).find(function(pp){return pp.id === (s && s.planId);});
            return p && p.topic || undefined;
          } catch(_) { return undefined; }
        })(),
        // iso: iso, // optional
      }).catch(console.warn);
    }
  } catch(_) {}

  renderAll();
}


    function setTuitionStatus(iso, idx, status){
      upsertDay(iso, function(d){
        var t = d.tuition[idx]; if(!t) return;
        t.status = status;
      });
      renderAll();
    }
    function removeActual(iso, id){
      upsertDay(iso, function(d){
        var idx = (d.actuals||[]).findIndex(function(a){return a.id===id;});
        if(idx>=0){
          var a = d.actuals[idx];
          d.actuals.splice(idx,1);
          if(a && a.sessionPlanId){
            var p = d.plan.find(function(pp){return pp.id===a.sessionPlanId;});
            if(p) p.completed=false;
          }
        }
      });
    }
    function addExtraToday(){
      var iso = toIso(todayDate);
      var sid = document.getElementById("extra-subj").value || "math";
      var topic = document.getElementById("extra-topic").value || "";
      var s = document.getElementById("extra-start").value || "20:00";
      var e = document.getElementById("extra-end").value || toTime(parseM(s)+45);
      var mins = dur(s,e);
      upsertDay(iso, function(d){
        d.plan = (d.plan||[]);
        d.plan.push({id:cryptoUUID(), subjectId:sid, start:s, end:e, duration:mins, topic:topic, isExtra:true, cancelled:false});
      });
      document.getElementById("extra-topic").value = "";
      renderAll();
    }

    // Plan Screen
    function renderPlan(){
      seed(planDate);
      var iso = toIso(planDate);
      var day = state.days[iso] || {tuition:[],plan:[],actuals:[]};
      var goal = targetH(planDate);
      var tMins = (day.tuition||[]).reduce(function(a,t){ return (t.status==="confirmed"||t.status==="rescheduled")?a+dur(t.start,t.end):a; },0);
      var pMins = (day.plan||[]).reduce(function(a,p){ return a+(p.duration||dur(p.start,p.end)); },0);
      var fill = (tMins+pMins)/60;

      var root = document.getElementById("screen-plan");
      root.innerHTML = "";

      // Header with UNDO
      var header = el("div",{class:"row-space"},[
        el("h2",null,"Plan for "+planDate.toLocaleDateString(undefined,{weekday:'short',day:'numeric',month:'short'})),
        el("div",{class:"row"},[
          el("span",{class:"muted"}, isWend(planDate)?"Weekend target 6h":"Weekday target 4h"),
          el("button",{class:"btn", disabled:!hasUndo(iso), onclick:function(){ undoDay(iso); renderAll(); }}, "⟲ Undo")
        ])
      ]);
      root.appendChild(el("div",{class:"section"},[
        header,
        el("div",{class:"bar", style:"margin-top:8px"}, [el("div",{style:"width:"+Math.min(100,Math.round((fill/goal)*100))+"%"})]),
        el("div",{class:"muted"},"(Tuition counts only after confirmation)")
      ]));

      // Date picker
      var dp = el("input",{class:"input",type:"date", value: toIso(planDate), onchange:function(e){ planDate = new Date(e.target.value); renderAll(); }});
      root.appendChild(el("div",{class:"row",style:"margin-bottom:12px"},[ el("span",{class:"muted"},"Plan date:"), dp ]));

      // Tuitions
      var secT = el("div",{class:"section"},[ el("h2",null,"Tuitions") ]);
      if((day.tuition||[]).length===0){
        secT.appendChild(el("div",{class:"muted"},"No tuitions for this date."));
      }else{
        (day.tuition||[]).forEach(function(t,idx){
          var chipClass = t.status==="confirmed"?"success":t.status==="rescheduled"?"info":t.status==="cancelled"?"warn":"warn";
          var chipText = t.status==="confirmed"?"Confirmed ✓":t.status==="rescheduled"?"Rescheduled ↺":t.status==="cancelled"?"Cancelled":"Pending";
          var row = el("div",{class:"card row-space"},[
            el("div",null,[ el("div",null, subjectLabel(t.subjectId)), el("div",{class:"muted"}, t.start+"–"+t.end) ]),
            el("div",{class:"row"},[
              el("span",{class:"chip "+chipClass}, chipText),
              el("button",{class:"btn",onclick:function(){ setTuitionStatus(iso,idx,'confirmed'); }}, "✓"),
              el("button",{class:"btn",onclick:function(){ setTuitionStatus(iso,idx,'cancelled'); }}, "✗"),
              el("button",{class:"btn",onclick:function(){ openResModal(iso,idx,t.start,t.end); }}, "↺")
            ])
          ]);
          // warnings (PLAN: tuition)
(function(){
  var w = buildWarning(iso, t.start, t.end);
  if(w) row.appendChild(el("div",{class:"muted"}, w));
})();

secT.appendChild(row);
        });
      }
      root.appendChild(secT);

      // Add Self-Study
      var secAdd = el("div",{class:"section"},[ el("h2",null,"Add Self-Study") ]);
      var sel = el("select",{id:"plan-subj",class:"input"}, SUBJECTS.map(function(s){ return el("option",{value:s.id}, s.name); }));
      var topic = el("input",{id:"plan-topic",class:"input",placeholder:"Topic (optional)"});
      var sI = el("input",{id:"plan-start",class:"input",type:"time"});
      var eI = el("input",{id:"plan-end",class:"input",type:"time"});
      var addB = el("button",{class:"btn",onclick:function(){ addPlanBlock(); }}, "Add");
      secAdd.appendChild(el("div",{class:"grid grid3"},[ sel, topic, el("div",{class:"row"},[sI, el("div",{class:"muted"},"–"), eI, addB]) ]));
      root.appendChild(secAdd);

      // Planned Blocks
      var secP = el("div",{class:"section"},[ el("h2",null,"Planned Blocks") ]);
      (day.plan||[]).forEach(function(p,idx){ if(p && p.isExtra && p.cancelled) return;
        var editing = false;
        var row = el("div",{class:"card"},[]);
        function redraw(){
          row.innerHTML = "";
          if(editing){
            var es = el("input",{class:"input",type:"time",value:p.start});
            var ee = el("input",{class:"input",type:"time",value:p.end});
            var et = el("input",{class:"input",type:"text",value:(p.topic||""),placeholder:"Topic (optional)"});
            row.appendChild(el("div",{class:"row-space"},[
              el("div",{class:"muted"}, subjectLabel(p.subjectId)),
              el("div",{class:"row"},[
                el("button",{class:"btn",onclick:function(){ p.start=es.value; p.end=ee.value; p.topic=et.value; p.duration=dur(p.start,p.end); upsertDay(iso,function(d){ var a=d.plan; a[idx]=p; }); renderAll(); }}, "Save"),
                el("button",{class:"btn",onclick:function(){ editing=false; redraw(); }}, "Cancel")
              ])
            ]));
                        // warning (PLAN: self-study)
            (function(){ var w = buildWarning(toIso(planDate), p.start, p.end); if(w) row.appendChild(el("div",{class:"muted"}, w)); })();
row.appendChild(el("div",{class:"row",style:"gap:6px;margin-top:8px"},[es, el("span",{class:"muted"},"–"), ee, et]));
            // warning (PLAN: self-study, editing)
            (function(){ var w = buildWarning(iso, p.start, p.end); if(w) row.appendChild(el("div",{class:"muted"}, w)); })();

          }else{
            row.appendChild(el("div",{class:"row-space"},[
              el("div",null,[ el("div",null, subjectLabel(p.subjectId)), el("div",{class:"muted"}, p.start+"–"+p.end+" ("+Math.round(p.duration)+"m)"+(p.topic?(" · "+p.topic):"")) ]),
              el("div",{class:"row"},[
                el("button",{class:"btn",onclick:function(){ editing=true; redraw(); }}, "Edit"),
                el("button",{class:"btn",onclick:function(){ removePlanBlock(idx); }}, "🗑 Remove")
              ])
            ]));
          }
        }
        redraw();
        secP.appendChild(row);
      });
      if((day.plan||[]).length===0) secP.appendChild(el("div",{class:"muted"},"No planned blocks yet."));
      root.appendChild(secP);
    }

    function addPlanBlock(){
      var iso = toIso(planDate);
      var sid = document.getElementById("plan-subj").value || "math";
      var topic = document.getElementById("plan-topic").value || "";
      var s = document.getElementById("plan-start").value || "20:00";
      var e = document.getElementById("plan-end").value || toTime(parseM(s)+45);
      var mins = dur(s,e);
      upsertDay(iso, function(d){
        d.plan = (d.plan||[]);
        d.plan.push({id:cryptoUUID(), subjectId:sid, start:s, end:e, duration:mins, topic:topic, isExtra:true, cancelled:false});
      });
      document.getElementById("plan-topic").value="";
      renderAll();
    }
    function removePlanBlock(idx){
      var iso = toIso(planDate);
      upsertDay(iso, function(d){
        d.plan.splice(idx,1);
      });
      renderAll();
    }

    // Summary Screen
    function renderSummary(){
      var root = document.getElementById("screen-summary");
      root.innerHTML = "";
      var title = "Week of "+summaryWeek.toLocaleDateString(undefined,{month:'short',day:'numeric'})+" – "+addDays(summaryWeek,6).toLocaleDateString(undefined,{month:'short',day:'numeric'});
      root.appendChild(el("div",{class:"section"},[ el("div",{class:"row-space"},[   el("h2",null,title),   el("button",{class:"btn", id:"exportPdfBtn", onclick:function(){ var mon=weekMon(summaryWeek); var from=toIso(mon); var to=toIso(addDays(mon,6)); var SB_URL=(localStorage.getItem('SB_URL')||'https://ryeonmdmzsczrgszaatc.supabase.co'); var SB_KEY=(localStorage.getItem('SB_KEY')||'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5ZW9ubWRtenNjenJnc3phYXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NjYwMTUsImV4cCI6MjA3MjE0MjAxNX0.sPXg-enI268EthpIfKF_tsZT1JqgITsQxVuqJaEzZ_Y'); var url='/summary-print.html?from='+from+'&to='+to   + '&sbUrl='+encodeURIComponent(SB_URL)   + '&sbKey='+encodeURIComponent(SB_KEY); window.open(url,'_blank');}},"Export PDF") ]) ]));
// Cloud (beta): enter URL/key once, stored only in this browser
var secCloud = el("div",{class:"section"},[
  el("h2",null,"Cloud (beta)"),
  el("div",{class:"row",style:"gap:8px;flex-wrap:wrap"},[
    (function(){
      var inp = el("input",{class:"input", placeholder:"Supabase Project URL (https://xxxx.supabase.co)", value: SUPABASE_URL });
      inp.oninput = function(e){ SUPABASE_URL = e.target.value.trim(); localStorage.setItem('supa_url', SUPABASE_URL); sb = null; };
      return inp;
    })(),
    (function(){
      var inp = el("input",{class:"input", placeholder:"Anon public key", value: SUPABASE_ANON });
      inp.oninput = function(e){ SUPABASE_ANON = e.target.value.trim(); localStorage.setItem('supa_anon', SUPABASE_ANON); sb = null; };
      return inp;
    })(),
    el("button",{class:"btn",onclick:testFetchPlan},"Test fetch planned")
  ]),
  el("div",{class:"muted"},"Stores URL/key in this browser only. We'll lock security later.")
]);
// Add User ID input + Sync TODAY button
(function(){
  var row = el("div",{class:"row", style:"gap:8px;flex-wrap:wrap;margin-top:8px"},[
    (function(){
      var inp = el("input",{class:"input", placeholder:"Supabase User ID (uuid)", value: SUPA_USER_ID });
      inp.oninput = function(e){ SUPA_USER_ID = e.target.value.trim(); localStorage.setItem('supa_user_id', SUPA_USER_ID); };
      return inp;
    })(),
    el("button",{class:"btn", onclick: syncTodayPlan}, "Sync TODAY plan → cloud")
  ]);
  secCloud.appendChild(row);
})();

root.appendChild(secCloud);

// Add "Sync PLAN day → cloud" button (uses the date you’ve selected on Plan)
(function(){
  var row2 = el("div",{class:"row", style:"gap:8px;flex-wrap:wrap;margin-top:6px"},[
    el("button",{class:"btn", onclick: function(){ syncPlanDay(toIso(planDate)); }}, "Sync PLAN day → cloud")
  ]);
  secCloud.appendChild(row2);
})();

// Add "Sync TODAY log → cloud" button
(function(){
  var row3 = el("div",{class:"row", style:"gap:8px;flex-wrap:wrap;margin-top:6px"},[
    el("button",{class:"btn", onclick: syncTodayActual}, "Sync TODAY log → cloud")
  ]);
  secCloud.appendChild(row3);
})();

// Add "Sync SELECTED DAY log → cloud" button
(function(){
  var row4 = el("div",{class:"row", style:"gap:8px;flex-wrap:wrap;margin-top:6px"},[
    el("button",{class:"btn", onclick: syncSelectedDayActual}, "Sync SELECTED DAY log → cloud")
  ]);
  secCloud.appendChild(row4);
})();

// Add "Check SELECTED DAY on cloud" button
(function(){
  var row5 = el("div",{class:"row", style:"gap:8px;flex-wrap:wrap;margin-top:6px"},[
    el("button",{class:"btn", onclick: checkSelectedDayCloud}, "Check SELECTED DAY on cloud")
  ]);
  secCloud.appendChild(row5);
})();

// Profile Save/Load (WhatsApp + timezone)
(function(){
  var nameInp   = el("input",{class:"input", placeholder:"Full name (e.g., Meher)"});
  var meherInp  = el("input",{class:"input", placeholder:"Meher WhatsApp (e.g., +91xxxxxxxxxx)"});
  var parentInp = el("input",{class:"input", placeholder:"Parent WhatsApp (e.g., +91xxxxxxxxxx)"});
  var tzInp     = el("input",{class:"input", placeholder:"Time zone (e.g., Asia/Kolkata)", value:"Asia/Kolkata"});
  var dailyCb   = el("input",{type:"checkbox", checked:true});
  var weeklyCb  = el("input",{type:"checkbox", checked:true});

  async function saveProfile(){
    try{
      if(!supaReady()){ alert("Enter Supabase URL & anon key first."); return; }
      if(!SUPA_USER_ID){ alert("Sign in first."); return; }
      var row = {
        user_id: SUPA_USER_ID,
        full_name: nameInp.value.trim() || null,
        meher_phone: meherInp.value.trim() || null,
        parent_phone: parentInp.value.trim() || null,
        tz: tzInp.value.trim() || "Asia/Kolkata",
        daily_opt_in: !!dailyCb.checked,
        weekly_parent_opt_in: !!weeklyCb.checked
      };
      var { error } = await sb.from('profiles').upsert(row).select('user_id');
      if(error) throw error;
      alert("Profile saved.");
    }catch(e){ alert("Save failed: " + e.message); }
  }

  async function loadProfile(){
    try{
      if(!supaReady()){ alert("Enter Supabase URL & anon key first."); return; }
      if(!SUPA_USER_ID){ alert("Sign in first."); return; }
      var { data, error } = await sb.from('profiles').select('*').eq('user_id', SUPA_USER_ID).single();
      if(error){ alert("Load failed: " + error.message); return; }
      if(!data){ alert("No profile found."); return; }
      nameInp.value   = data.full_name || "";
      meherInp.value  = data.meher_phone || "";
      parentInp.value = data.parent_phone || "";
      tzInp.value     = data.tz || "Asia/Kolkata";
      dailyCb.checked = !!data.daily_opt_in;
      weeklyCb.checked= !!data.weekly_parent_opt_in;
      alert("Profile loaded.");
    }catch(e){ alert("Load failed: " + e.message); }
  }

  var rowP = el("div",{class:"section"},[
    el("h2",null,"Profile (for WhatsApp & reminders)"),
    el("div",{class:"row",style:"gap:8px;flex-wrap:wrap"},[
      nameInp, meherInp, parentInp, tzInp,
      el("label",null,[ dailyCb,  el("span",{style:"margin-left:6px"}, "Daily nudges") ]),
      el("label",null,[ weeklyCb, el("span",{style:"margin-left:6px"}, "Weekly parent summary") ]),
      el("button",{class:"btn", onclick: saveProfile}, "Save profile"),
      el("button",{class:"btn", onclick: loadProfile}, "Load profile")
    ])
  ]);
  secCloud.appendChild(rowP);
})();

// WhatsApp test button
(function(){
  var rowWA = el("div",{class:"row", style:"gap:8px;flex-wrap:wrap;margin-top:6px"},[
    el("button",{class:"btn", onclick: sendWhatsAppHello}, "Send WhatsApp hello")
  ]);
  secCloud.appendChild(rowWA);
})();

if (!SHOW_CLOUD) secCloud.style.display = "none";


// Auth (email magic link) row
(function(){
  var rowAuth = el("div",{class:"row", style:"gap:8px;flex-wrap:wrap;margin-top:6px"},[
    (function(){
      var inp = el("input",{class:"input", placeholder:"Email for magic link", value: AUTH_EMAIL });
      inp.oninput = function(e){ AUTH_EMAIL = e.target.value.trim(); localStorage.setItem('supa_email', AUTH_EMAIL); };
      return inp;
    })(),
    el("button",{class:"btn", onclick: function(){ sendMagicLink(AUTH_EMAIL); }}, "Send sign-in link"),
    el("button",{class:"btn", onclick: signOut}, "Sign out"),
    (function(){
      var span = el("span",{id:"auth-status", class:"muted"}, "Not signed in");
      // try reflect current session in UI
      setTimeout(function(){
        if(SUPA_USER_ID){
          span.textContent = "Signed in (uid): " + SUPA_USER_ID;
        }
      }, 0);
      return span;
    })()
  ]);
  secCloud.appendChild(rowAuth);
})();


      // Weekly progress ring
      try{
        var weekly = weekHoursTotal(summaryWeek); // hours this week
        var goal = 32; // weekly goal in hours
        var pct = Math.max(0, Math.min(100, Math.round((weekly/goal)*100)));
        var ring = el("div",{class:"c-ring", style:"--p:"+pct},[ el("div",{class:"c-label"}, (weekly.toFixed(1)+" / "+goal+"h")) ]);
        var secRing = el("div",{class:"section"},[
          el("div",{class:"c-ring-wrap"},[ ring, el("div",null,[
            el("div",{class:"muted"},"Weekly progress"),
            el("div",null, pct+"%")
          ]) ])
        ]);
        root.appendChild(secRing);
      }catch(_){}


      // Daily totals row
      var daily = [];
      for(var i=0;i<7;i++){
        var iso = toIso(addDays(summaryWeek,i));
        var day = state.days[iso];
        var mins = day && day.actuals ? day.actuals.reduce(function(a,x){return a+(x.duration||0)},0) : 0;
        daily.push(mins/60);
      }
      root.appendChild(el("div",{class:"section"},[
        el("h2",null,"Daily totals"),
        el("div",{class:"muted"}, ["M","T","W","Th","F","Sa","Su"].map(function(d,i){ return d+" "+(daily[i]||0).toFixed(1); }).join(" | "))
      ]));

      // Subject hours
      var subTot = {};
      for(var i=0;i<7;i++){
        var iso = toIso(addDays(summaryWeek,i));
        var day = state.days[iso];
        if(day && day.actuals){
          day.actuals.forEach(function(a){
            subTot[a.subjectId] = (subTot[a.subjectId]||0) + (a.duration||0)/60;
          });
        }
      }
      var secS = el("div",{class:"section"},[ el("h2",null,"Subject hours (4h min)") ]);
      SUBJECTS.forEach(function(s){
        var h = +( (subTot[s.id]||0).toFixed(1) );
        var row = el("div",{class:"card"},[
          el("div",{class:"row-space"},[ el("div",{class:"muted"}, s.name), el("div",{class:"muted"}, h.toFixed(1)+"h") ]),
          el("div",{class:"bar"},[ el("div",{style:"width:"+Math.min(100,(h/8)*100)+"%;background:"+s.color}) ])
        ]);
                row.className += " sub-"+s.id;
secS.appendChild(row);
      });
      root.appendChild(secS);

      // Week nav
      var nav = el("div",{class:"row",style:"gap:8px"},[
        el("button",{class:"btn",onclick:function(){ summaryWeek = addDays(summaryWeek,-7); renderAll(); }}, "◀ Prev"),
        el("button",{class:"btn",onclick:function(){ summaryWeek = weekMon(new Date()); renderAll(); }}, "This Week"),
        el("button",{class:"btn",onclick:function(){ summaryWeek = addDays(summaryWeek,7); renderAll(); }}, "Next ▶")
      ]);
      root.appendChild(nav);
    
  // Backup section (export only)
  try{
    var secBackup = el("div",{class:"section"},[
      el("h2",null,"Backup"),
      el("div",{class:"row",style:"gap:8px"},[
        el("button",{class:"btn",onclick:exportState},"Export data (JSON)")
      ]),
      el("div",{class:"muted"},"Saves your current data to a .json file you can keep.")
    ]);
    root.appendChild(secBackup);
  }catch(_){}

  // Restore / Reset section
  try{
    var secRestore = el("div",{class:"section"},[
      el("h2",null,"Restore / Reset"),
      el("div",{class:"row",style:"gap:8px;flex-wrap:wrap"},[
        el("button",{class:"btn",onclick:openImportDialog},"Import data (JSON)"),
        el("button",{class:"btn",onclick:resetAppData},"Reset app data")
      ]),
      el("div",{class:"muted"},"Import replaces your current data with a backup file. Reset clears local data (useful for testing a fresh start).")
    ]);
    root.appendChild(secRestore);
  }catch(_){}
}

    // Modal logic
    var resCtx = null;
    function openResModal(iso, idx, start, end){
      resCtx = {mode:"tuition", iso:iso, idx:idx};
      var rt=document.getElementById("res-title"); if(rt) rt.textContent="Reschedule Tuition";
      var rd=document.getElementById("res-date"); if(rd){ rd.disabled=false; rd.value = iso; }
      var wrap=document.getElementById("res-subj-wrap"); if(wrap) wrap.style.display="none";
      document.getElementById("res-start").value = start;
      document.getElementById("res-end").value = end;
      document.getElementById("res-modal").style.display = "flex";
    }
    function closeResModal(){ document.getElementById("res-modal").style.display = "none"; var wrap=document.getElementById("res-subj-wrap"); if(wrap) wrap.style.display="none"; resCtx=null; }
    document.getElementById("res-x").onclick = closeResModal;
    document.getElementById("res-cancel").onclick = closeResModal;
    document.getElementById("res-save").onclick = function(){
      if(!resCtx) return closeResModal();
      var iso = resCtx.iso;
      var s = document.getElementById("res-start").value || "20:00";
      var e = document.getElementById("res-end").value || "21:00";
      if(resCtx && (resCtx.mode==="extra" || resCtx.mode==="self")){
        var sid = (document.getElementById("res-subject")||{}).value || null;
        var iso = resCtx.iso;
        upsertDay(iso, function(d){
          d.plan = (d.plan||[]);
          var p = d.plan.find(function(pp){ return pp.id===resCtx.planId; });
          if(p){
            if(sid) p.subjectId = sid;
            p.start = s; p.end = e; p.duration = dur(s,e);
          }
        });
        closeResModal();
        renderAll();
        return;
      }

      if(resCtx.mode==="extra"){
        upsertDay(iso, function(d){
          var arr = d.plan || [];
          var p = arr.find(function(pp){ return pp.id===resCtx.planId; });
          if(p){
            p.start = s; p.end = e; p.duration = dur(s,e);
          }
        });
        closeResModal(); renderAll(); return;
      }
    
      if(!resCtx) return closeResModal();
      var iso = resCtx.iso, idx = resCtx.idx;
      var newDate = document.getElementById("res-date").value;
      var s = document.getElementById("res-start").value || "20:00";
      var e = document.getElementById("res-end").value || "21:00";
      if(newDate===iso){
        upsertDay(iso,function(d){
          var t = d.tuition[idx]; if(!t) return;
          t.status = "rescheduled"; t.start=s; t.end=e;
        });
      }else{
        var moving;
        upsertDay(iso,function(d){
          moving = d.tuition[idx];
          d.tuition.splice(idx,1);
        });
        upsertDay(newDate,function(d){
          d.tuition = (d.tuition||[]);
          d.tuition.push({id:cryptoUUID(),subjectId:moving.subjectId,start:s,end:e,status:"rescheduled"});
        });
      }
      closeResModal();
      renderAll();
    };

    // --- Extra block helpers ---
    function openExtraEditModal(iso, planId, start, end){
      resCtx = {mode:"extra", iso:iso, planId:planId};
      var rt=document.getElementById("res-title"); if(rt) rt.textContent="Edit Extra Block";
      var rd=document.getElementById("res-date"); if(rd){ rd.disabled=true; rd.value = iso; }
      ensureResSubjectOptions();
      var wrap=document.getElementById("res-subj-wrap"); if(wrap) wrap.style.display="block";
      var sel=document.getElementById("res-subject");
      (function(){
        var d = state.days[iso] || {plan:[]};
        var p = (d.plan||[]).find(function(pp){return pp.id===planId;});
        if(p && sel){ sel.value = p.subjectId; }
      })();
      document.getElementById("res-start").value = start || "20:00";
      document.getElementById("res-end").value = end || "21:00";
      document.getElementById("res-modal").style.display = "flex";
    }
    function cancelExtra(iso, planId){
      upsertDay(iso, function(d){
        var p = (d.plan||[]).find(function(pp){return pp.id===planId;});
        if(p && p.isExtra){ p.cancelled = true; }
      });
      renderAll();
    }

    function ensureResSubjectOptions(){
      var sel = document.getElementById("res-subject");
      if(!sel) return;
      sel.innerHTML = "";
      (SUBJECTS||[]).forEach(function(s){
        var opt = document.createElement("option");
        opt.value = s.id; opt.textContent = s.name;
        sel.appendChild(opt);
      });
    }
    function openSelfEditModal(iso, planId, start, end){
      resCtx = {mode:"self", iso:iso, planId:planId};
      var rt=document.getElementById("res-title"); if(rt) rt.textContent="Edit Study Block";
      var rd=document.getElementById("res-date"); if(rd){ rd.disabled=true; rd.value = iso; }
      ensureResSubjectOptions();
      var wrap=document.getElementById("res-subj-wrap"); if(wrap) wrap.style.display="block";
      var sel=document.getElementById("res-subject");
      (function(){
        var d = state.days[iso] || {plan:[]};
        var p = (d.plan||[]).find(function(pp){return pp.id===planId;});
        if(p && sel){ sel.value = p.subjectId; }
      })();
      document.getElementById("res-start").value = start || "20:00";
      document.getElementById("res-end").value = end || "21:00";
      document.getElementById("res-modal").style.display = "flex";
    }

// Small helper to render "30 August 2025" style dates
function fmtPretty(iso){
  try{
    var d = new Date(iso+"T00:00:00");
    var opts = { day:"numeric", month:"long", year:"numeric" };
    return d.toLocaleDateString(undefined, opts);
  }catch(_){ return iso; }
}

// Helpers — quick duration nudge & move to D+1 (self-study only)
function adjustPlanDuration(iso, planId, deltaMins){
  upsertDay(iso, function(d){
    var p = (d.plan||[]).find(function(pp){ return pp.id===planId; });
    if(!p) return;
    var start = p.start || "20:00";
    // Base mins: existing duration OR (end-start) OR default 45 if end missing
    var base = p.duration;
    if(!base){
      var endGuess = p.end ? p.end : toTime(parseM(start) + 45);
      base = dur(start, endGuess);
    }
    var mins = Math.max(15, base + deltaMins);
    p.end = toTime(parseM(start) + mins);
    p.duration = mins;
  });
  renderAll();
}

function movePlanToTomorrow(iso, planId){
  var d = new Date(iso + "T00:00:00"); d.setDate(d.getDate() + 1);
  var nextIso = toIso(d);
  var moving = null;
  upsertDay(iso, function(day){
    var i = (day.plan||[]).findIndex(function(pp){ return pp.id===planId; });
    if(i > -1){ moving = day.plan[i]; day.plan.splice(i,1); }
  });
  if(moving){
    upsertDay(nextIso, function(day2){
      day2.plan = (day2.plan||[]);
      var copy = JSON.parse(JSON.stringify(moving));
      copy.id = cryptoUUID();
      day2.plan.push(copy);
    });
  }
  renderAll();
}
// --- Hints: overlaps + school hours (Mon–Fri 07:30–15:00) ---
function isWeekday(d){ return d.getDay()>=1 && d.getDay()<=5; }
function inSchoolHours(s,e){
  var toM = t => parseInt(t.slice(0,2),10)*60 + parseInt(t.slice(3),10);
  var ss = toM(s), ee = toM(e), schS = 7*60+30, schE = 15*60;
  return Math.max(ss, schS) < Math.min(ee, schE);
}
function overlaps(aS,aE,bS,bE){
  var toM = t => parseInt(t.slice(0,2),10)*60 + parseInt(t.slice(3),10);
  var as = toM(aS), ae = toM(aE), bs = toM(bS), be = toM(bE);
  return Math.max(as, bs) < Math.min(ae, be);
}
function buildWarning(iso, startStr, endStr){
  var warn = [];
  var dateObj = new Date(iso+"T00:00:00");
  if(isWeekday(dateObj) && inSchoolHours(startStr,endStr)) warn.push("School hours");

  var d2 = state.days[iso] || {tuition:[],plan:[],actuals:[]};
  var times = [];
  (d2.tuition||[]).filter(t => t.status!=="cancelled").forEach(t => times.push([t.start,t.end]));
  (d2.plan||[]).filter(p => !(p.isExtra && p.cancelled)).forEach(p => times.push([p.start,p.end]));

  var hasOverlap = times.some(([os,oe]) => (os!==startStr || oe!==endStr) && overlaps(startStr,endStr,os,oe));
  if(hasOverlap) warn.push("Overlaps");

  return warn.length ? "⚠ " + warn.join(" · ") : null;
}

// --- restore & reset helpers ---
function openImportDialog(){
  var inp = document.getElementById('import-json-input');
  if(!inp){
    inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = '.json,application/json';
    inp.id = 'import-json-input';
    inp.style.display = 'none';
    inp.onchange = function(e){
      var f = e.target.files && e.target.files[0];
      if(!f) return;
      handleImportFile(f);
      // reset input so same file can be re-chosen if needed
      e.target.value = '';
    };
    document.body.appendChild(inp);
  }
  inp.click();
}
function handleImportFile(file){
  try{
    var reader = new FileReader();
    reader.onload = function(ev){
      try{
        var data = JSON.parse(ev.target.result || 'null');
      }catch(e){
        alert('Invalid JSON file: ' + e.message); return;
      }
      if(!data || typeof data !== 'object' || !data.days || typeof data.days !== 'object'){
        alert('This file does not look like a Meher backup (missing "days").');
        return;
      }
      if(!confirm('Import will REPLACE your current data with the backup. Continue?')) return;
      state = data;
      save(state);
      renderAll();
      alert('Import complete.');
    };
    reader.onerror = function(){ alert('Failed to read file.'); };
    reader.readAsText(file);
  }catch(e){
    alert('Import failed: ' + e.message);
  }
}
function resetAppData(){
  if(!confirm('This will CLEAR all local data for this app. Are you sure?')) return;
  try{
    localStorage.clear(); sessionStorage.clear();
  }catch(_){}
  location.reload();
}
// --- Supabase minimal wiring (read-only test) ---
var SUPABASE_URL  = localStorage.getItem('supa_url')  || "";
var SUPABASE_ANON = localStorage.getItem('supa_anon') || "";
var sb = null;

function supaReady(){
  try{
    if(!window.supabase){ return false; }
    if(!sb){
      if(!SUPABASE_URL || !SUPABASE_ANON) return false;
      sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    }
    return true;
  }catch(_){ return false; }
}

async function testFetchPlan(){
  try{
    if(!supaReady()){ alert("Supabase not ready. Enter URL & anon key, then try again."); return; }
    var q = sb.from('sessions_plan').select('*').order('inserted_at', { ascending:false }).limit(5);
    var { data, error } = await q;
    if(error){ alert("Error: " + error.message); return; }
    if(!data || !data.length){ alert("Connected! Table found, 0 rows."); return; }
    alert("Connected! Fetched "+data.length+" row(s). First iso: " + (data[0].iso || "—"));
  }catch(e){
    alert("Fetch failed: " + e.message);
  }
}
// --- Cloud sync (manual, today only) ---
var SUPA_USER_ID = localStorage.getItem('supa_user_id') || "";

// turn one day’s plan/tuition into rows for sessions_plan
function collectPlanRows(iso){
  var d = state.days[iso] || {};
  var rows = [];
  // self-study plan
  (d.plan||[]).forEach(function(p){
    if(!p.start || !p.end) return;
    rows.push({
      user_id: SUPA_USER_ID,
      iso: iso,
      kind: 'self',
      subject_id: p.subjectId,
      start_min: parseM(p.start),
      end_min: parseM(p.end),
      topic: p.topic || null,
      is_extra: !!p.isExtra,
      cancelled: !!p.cancelled
    });
  });
  // tuitions
  (d.tuition||[]).forEach(function(t){
    if(!t.start || !t.end) return;
    rows.push({
      user_id: SUPA_USER_ID,
      iso: iso,
      kind: 'tuition',
      subject_id: t.subjectId,
      start_min: parseM(t.start),
      end_min: parseM(t.end),
      topic: t.topic || null,
      is_extra: false,
      cancelled: (t.status === 'cancelled')
    });
  });
  return rows;
}

async function syncPlanDay(iso){
  try{
    if(!supaReady()){ alert("Enter Supabase URL & anon key first."); return; }
    if(!SUPA_USER_ID){ alert("Enter Supabase User ID first."); return; }
    var rows = collectPlanRows(iso);
    if(!rows.length){ alert("Nothing to sync for "+iso); return; }
    // avoid duplicates: clear this user+day, then insert fresh
    var del = await sb.from('sessions_plan').delete().eq('user_id', SUPA_USER_ID).eq('iso', iso);
    if(del.error){ alert("Delete failed: " + del.error.message); return; }
    var ins = await sb.from('sessions_plan').insert(rows).select('id');
    if(ins.error){ alert("Insert failed: " + ins.error.message); return; }
    alert("Synced " + rows.length + " row(s) for " + iso);
  }catch(e){
    alert("Sync failed: " + e.message);
  }
}

function syncTodayPlan(){
  return syncPlanDay(toIso(todayDate));
}

// --- ACTUALS (Today’s Log) → Supabase (FK-safe: no plan_id yet) ---
function _toMinutesMaybe(v){
  if (v == null) return null;
  if (typeof v === "number" && isFinite(v)) return v|0;
  if (typeof v === "string"){
    var s = v.trim();
    if (/^\d+$/.test(s)) return parseInt(s,10);
    var m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (m) return (+m[1])*60 + (+m[2]);
  }
  return null;
}
function _firstDefined(){ for (var i=0;i<arguments.length;i++){ if (arguments[i] != null) return arguments[i]; } return null; }

function collectActualRows(iso){
  var d = state.days[iso] || {};
  var arr = Array.isArray(d.actuals) ? d.actuals : [];

  var rows = [];
  arr.forEach(function(a){
    if(!a) return;

    var subj = a.subjectId || a.subject || a.subjId;
    if(!subj) return;

    // Your data uses startActual / endActual (+ duration)
    var sm = _toMinutesMaybe(_firstDefined(
      a.startActual, a.start_actual,
      a.start_min, a.startMin, a.startM, a.start, a.from
    ));
    var em = _toMinutesMaybe(_firstDefined(
      a.endActual, a.end_actual,
      a.end_min, a.endMin, a.endM, a.end, a.to
    ));
    var dur = _firstDefined(a.durationMin, a.duration, a.minutes, a.mins, null);

    if (dur == null && sm!=null && em!=null) dur = Math.max(0, em - sm);
    if (dur!=null && sm!=null && em==null) em = sm + dur;
    if (dur!=null && em!=null && sm==null) sm = em - dur;

    if (sm==null || em==null || dur==null) return;

    rows.push({
      user_id: SUPA_USER_ID,
      iso: iso,
      subject_id: subj,
      start_min: sm,
      end_min: em,
      duration_min: dur,
      topic: a.topic || null,
      // TEMP: avoid FK errors until plan IDs are synced 1:1
      plan_id: null
    });
  });

  return rows;
}

async function syncActualDay(iso){
  try{
    if(!supaReady()){ alert("Enter Supabase URL & anon key first."); return; }
    if(!SUPA_USER_ID){ alert("Enter Supabase User ID first."); return; }
    var rows = collectActualRows(iso);
    if(!rows.length){ alert("No completed items to sync for "+iso); return; }
    // replace this user+day to avoid duplicates
    var del = await sb.from('sessions_actual').delete().eq('user_id', SUPA_USER_ID).eq('iso', iso);
    if(del.error){ alert("Delete failed: " + del.error.message); return; }
    var ins = await sb.from('sessions_actual').insert(rows).select('id');
    if(ins.error){ alert("Insert failed: " + ins.error.message); return; }
    alert("Synced " + rows.length + " log row(s) for " + iso + " → sessions_actual");
  }catch(e){
    alert("Sync failed: " + e.message);
  }
}
function syncTodayActual(){ return syncActualDay(toIso(todayDate)); }

function syncSelectedDayActual(){ return syncActualDay(toIso(planDate)); }

// --- Read-only cloud check for the selected Plan date ---
async function checkSelectedDayCloud(){
  try{
    if(!supaReady()){ alert("Enter Supabase URL & anon key first."); return; }
    if(!SUPA_USER_ID){ alert("Enter Supabase User ID first."); return; }

    var iso = toIso(planDate);

    // Count plan rows
    var r1 = await sb
      .from('sessions_plan')
      .select('*', { head: true, count: 'exact' })
      .eq('user_id', SUPA_USER_ID)
      .eq('iso', iso);

    if(r1.error){ alert("Plan count error: " + r1.error.message); return; }

    // Count actual (log) rows
    var r2 = await sb
      .from('sessions_actual')
      .select('*', { head: true, count: 'exact' })
      .eq('user_id', SUPA_USER_ID)
      .eq('iso', iso);

    if(r2.error){ alert("Log count error: " + r2.error.message); return; }

    var planCount = r1.count || 0;
    var logCount  = r2.count || 0;

    alert("Cloud has " + planCount + " plan row(s) and " + logCount + " log row(s) for " + iso + ".");
  }catch(e){
    alert("Check failed: " + e.message);
  }
}

// --- Auth (email magic link) + hook SUPA_USER_ID to session ---
var AUTH_EMAIL = localStorage.getItem('supa_email') || "";

function setAuthUser(user){
  if(user && user.id){
    SUPA_USER_ID = user.id;                        // use real auth uid
    localStorage.setItem('supa_user_id', SUPA_USER_ID); // keep old code happy
  }
}

async function initAuth(){
  if(!supaReady()) return;
  try{
    // pick up session if returning via magic link
    var { data: { session } } = await sb.auth.getSession();
    setAuthUser(session?.user || null);

    // react to sign-in/out
    sb.auth.onAuthStateChange(function(evt, sess){
      setAuthUser(sess?.user || null);
      // Optional: light feedback
      try{
        var elStatus = document.getElementById("auth-status");
        if(elStatus){
          elStatus.textContent = sess?.user ? ("Signed in: " + (sess.user.email||sess.user.id)) : "Not signed in";
        }
      }catch(_){}
    });
  }catch(e){
    console.warn("initAuth failed:", e);
  }
}

async function sendMagicLink(email){
  try{
    if(!supaReady()){ alert("Enter Supabase URL & anon key first."); return; }
    email = (email||"").trim();
    if(!email){ alert("Enter your email first."); return; }
    localStorage.setItem('supa_email', email);
    var { error } = await sb.auth.signInWithOtp({
      email: email,
      options: { emailRedirectTo: "https://meher-is-locked-in.netlify.app/" }
    });
    if(error) throw error;
    alert("Magic link sent. Open your email on this device and click the link.");
  }catch(e){
    alert("Sign-in failed: " + e.message);
  }
}

async function signOut(){
  try{
    if(!supaReady()){ alert("Enter Supabase URL & anon key first."); return; }
    await sb.auth.signOut();
    alert("Signed out.");
  }catch(e){
    alert("Sign-out failed: " + e.message);
  }
}

// kick it off
initAuth();

// --- WhatsApp test helper (calls your Netlify Function) ---
async function sendWhatsAppHello(){
  try{
    if(!supaReady()){ alert("Enter Supabase URL & anon key first."); return; }
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ alert("Sign in first (magic link)."); return; }

    const res = await fetch("/.netlify/functions/send-whatsapp", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + session.access_token
      },
      body: JSON.stringify({})
    });
    const j = await res.json().catch(()=> ({}));
    if(!res.ok){ alert("WhatsApp failed: " + (j.error || res.statusText)); return; }
    alert("WhatsApp sent to " + (j.to || "number") + ". SID: " + (j.sid || ""));
  }catch(e){
    alert("Error: " + e.message);
  }
}

// Pre-fill Supabase URL/key so users don't have to paste
localStorage.setItem('supa_url',    'https://ryeonmdmzsczrgszaatc.supabase.co');   // <-- put your real URL
localStorage.setItem('supa_anon',   'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5ZW9ubWRtenNjenJnc3phYXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NjYwMTUsImV4cCI6MjA3MjE0MjAxNX0.sPXg-enI268EthpIfKF_tsZT1JqgITsQxVuqJaEzZ_Y');                 // <-- put your real anon key

// --- Auto-sync (silent) every 10 min and on tab close ---
var AUTO_SYNC = true;

async function silentSyncPlan(iso){
  try{
    if(!AUTO_SYNC || !supaReady() || !SUPA_USER_ID) return;
    var rows = collectPlanRows(iso);
    if(!rows || !rows.length) return;
    await sb.from('sessions_plan').delete().eq('user_id', SUPA_USER_ID).eq('iso', iso);
    await sb.from('sessions_plan').insert(rows);
    // console.log("Auto-synced plan", iso, rows.length);
  }catch(_){}
}

async function silentSyncActual(iso){
  try{
    if(!AUTO_SYNC || !supaReady() || !SUPA_USER_ID) return;
    var rows = collectActualRows(iso);
    if(!rows || !rows.length) return;
    await sb.from('sessions_actual').delete().eq('user_id', SUPA_USER_ID).eq('iso', iso);
    await sb.from('sessions_actual').insert(rows);
    // console.log("Auto-synced actual", iso, rows.length);
  }catch(_){}
}

function kickOffAutoSync(){
  if(!AUTO_SYNC) return;
  // every 10 minutes
  setInterval(function(){
    try{
      var isoToday = toIso(todayDate);
      var isoPlan  = toIso(planDate);
      silentSyncPlan(isoPlan);
      silentSyncActual(isoToday);
    }catch(_){}
  }, 10*60*1000);

  // when the tab becomes hidden (switch away)
  document.addEventListener('visibilitychange', function(){
    if(document.hidden){
      try{
        var isoToday = toIso(todayDate);
        var isoPlan  = toIso(planDate);
        silentSyncPlan(isoPlan);
        silentSyncActual(isoToday);
      }catch(_){}
    }
  });

  // just before unload/refresh
  window.addEventListener('beforeunload', function(){
    var isoToday = toIso(todayDate);
    var isoPlan  = toIso(planDate);
    // Fire-and-forget; browsers ignore async here but it's fine as a best-effort
    silentSyncPlan(isoPlan);
    silentSyncActual(isoToday);
  });
}

// start auto-sync once
setTimeout(kickOffAutoSync, 0);

var SHOW_CLOUD = location.search.includes("dev=1"); // Cloud panel only shows with ?dev=1


    // Root render
    function renderAll(){
      renderTabs(activeTab);
      renderToday();
      renderPlan();
      renderSummary();
    }

    // Tabs wiring
    var activeTab = "today";
    document.getElementById("tab-today").onclick = function(){ activeTab="today"; renderAll(); };
    document.getElementById("tab-plan").onclick = function(){ activeTab="plan"; renderAll(); };
    document.getElementById("tab-summary").onclick = function(){ activeTab="summary"; renderAll(); };

    // Initial paint
    renderAll();
  </script>

  <script>
    (function(){
      // Subject catalog fallback (uses SUBJECT_MAP if present)
      var MSA_SUBJECTS = [];
      if (typeof SUBJECT_MAP !== "undefined"){
        for (var id in SUBJECT_MAP){
          if (!SUBJECT_MAP.hasOwnProperty(id)) continue;
          var m = SUBJECT_MAP[id]||{};
          MSA_SUBJECTS.push({id:id, name:m.name||id, emoji:m.emoji||""});
        }
      }else{
        MSA_SUBJECTS = [
          {id:"eng-lang", name:"Eng Lang", emoji:"📘"},
          {id:"eng-lit",  name:"Eng Lit",  emoji:"📖"},
          {id:"french",   name:"French",   emoji:"🇫🇷"},
          {id:"history",  name:"History",  emoji:"🏛️"},
          {id:"math",     name:"Math",     emoji:"➗"},
          {id:"chem",     name:"Chem",     emoji:"⚗️"},
          {id:"bio",      name:"Bio",      emoji:"🧬"},
          {id:"ict",      name:"ICT",      emoji:"💻"}
        ];
      }

      function isoOf(d){ var z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
      function mondayOf(d){ var day=d.getDay(); var diff=(day===0?-6:(1-day)); var m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m; }
      function weekIsos(d){ var m=mondayOf(d), arr=[]; for(var i=0;i<7;i++){ var x=new Date(m); x.setDate(m.getDate()+i); arr.push((typeof toIso==="function")?toIso(x):isoOf(x)); } return arr; }

      function minutesToday(){
        var iso = (typeof toIso==="function") ? toIso(new Date()) : isoOf(new Date());
        var list = (window.state && state.days && state.days[iso] && state.days[iso].actuals) ? state.days[iso].actuals : [];
        return list.reduce(function(a,b){ return a + ((b.duration|0) || (b.duration_min|0) || 0); }, 0);
      }
      function minutesThisWeek(){
        var isos=weekIsos(new Date()); var sum=0;
        isos.forEach(function(iso){
          var list=(state&&state.days&&state.days[iso]&&state.days[iso].actuals)?state.days[iso].actuals:[];
          sum+=list.reduce(function(a,b){ return a+((b.duration|0)||(b.duration_min|0)||0); },0);
        });
        return sum;
      }
      function dailyTarget(d){ var n=d.getDay(); return (n===0||n===6)?360:240; }
      var WEEKLY_TARGET = 1920;

      function fmtHM(m){ m|=0; var h=(m/60)|0, mm=m%60; return h? (h+"h"+(mm?(" "+mm+"m"):"")) : (mm+"m"); }

      function ringTemplate(idBase, title){
        return ''+
          '<section class="msa-card" id="'+idBase+'Card">'+
            '<div class="msa-left-rings">'+
              // Minutes ring (left)
              '<div class="msa-ring-wrap">'+
                '<svg class="msa-ring" width="132" height="132">'+
                  '<circle class="bg" cx="66" cy="66" r="56"></circle>'+
                  '<circle class="fg" cx="66" cy="66" r="56" stroke-dasharray="351.86" stroke-dashoffset="351.86"></circle>'+
                '</svg>'+
                '<div class="msa-ring-center">'+
                  '<div class="big" id="'+idBase+'MinBig">0%</div>'+
                  '<div class="small" id="'+idBase+'MinSmall">0/0 min</div>'+
                '</div>'+
              '</div>'+
              // Hours ring (right)
              '<div class="msa-ring-wrap">'+
                '<svg class="msa-ring" width="132" height="132">'+
                  '<circle class="bg" cx="66" cy="66" r="56"></circle>'+
                  '<circle class="fg" cx="66" cy="66" r="56" stroke-dasharray="351.86" stroke-dashoffset="351.86"></circle>'+
                '</svg>'+
                '<div class="msa-ring-center">'+
                  '<div class="big" id="'+idBase+'HrBig">0h</div>'+
                  '<div class="small" id="'+idBase+'HrSmall">of 0h</div>'+
                '</div>'+
              '</div>'+
            '</div>'+
            '<div class="msa-right">'+
              '<div class="label" id="'+idBase+'Label">'+title+'</div>'+
              '<div class="msa-linear"><span id="'+idBase+'Linear"></span></div>'+
              '<div class="msa-legend" id="'+idBase+'Legend"></div>'+
            '</div>'+
          '</section>';
      }

      function setRingElems(root, percent, bigSel, smallSel, bigText, smallText){
        var r=56, circ=2*Math.PI*r, offset=circ*(1-Math.max(0,Math.min(1,percent)));
        var fg = root.querySelector(".msa-ring .fg"); if(fg){ fg.setAttribute("stroke-dasharray", String(circ.toFixed(2))); fg.setAttribute("stroke-dashoffset", String(offset.toFixed(2))); fg.setAttribute("stroke", percent>=1? "#10b981" : "#3b82f6"); }
        var big = root.querySelector(bigSel); if (big) big.textContent = bigText;
        var small = root.querySelector(smallSel); if (small) small.textContent = smallText;
      }

      function updateDualRings(idBase, doneMin, targetMin){
        var card = document.getElementById(idBase+"Card"); if(!card) return;
        var pct = targetMin ? (doneMin/targetMin) : 0;
        // Left ring: minutes
        setRingElems(card, pct, "#"+idBase+"MinBig", "#"+idBase+"MinSmall",
          Math.round(pct*100)+"%", (doneMin|0)+"/"+targetMin+" min");
        // Right ring: hours text
        setRingElems(card, pct, "#"+idBase+"HrBig", "#"+idBase+"HrSmall",
          fmtHM(doneMin), "of "+(targetMin/60)+"h");
        // Linear bar
        var lin = document.getElementById(idBase+"Linear"); if (lin) lin.style.width = Math.round(pct*100)+"%";
      }

      function populateLegend(prefix){
        var host=document.getElementById(prefix+"Legend"); if(!host) return;
        host.innerHTML="";
        MSA_SUBJECTS.forEach(function(s){
          var chip=document.createElement("div");
          chip.className="msa-chip";
          chip.setAttribute("data-subj", s.id);
          chip.setAttribute("data-name", s.name||s.id);
          var emo=document.createElement("span"); emo.className="emo"; emo.textContent=s.emoji||"";
          var name=document.createElement("span"); name.textContent=s.name||s.id;
          chip.appendChild(emo); chip.appendChild(name);
          host.appendChild(chip);
        });
      }

      function renderTodayBanner(){
        var host = document.getElementById("screen-today"); if(!host) return;
        var idBase = "today";
        if (!document.getElementById(idBase+"Card")){
          host.insertAdjacentHTML("afterbegin", ringTemplate(idBase, "Today’s Study Progress"));
          populateLegend(idBase);
        }
        var now = new Date();
        var target = dailyTarget(now);
        var done = minutesToday();
        updateDualRings(idBase, done, target);
      }

      function renderWeeklyBanner(){
        var host = document.getElementById("screen-summary"); if(!host) return;
        var idBase = "weekly";
        if (!document.getElementById(idBase+"Card")){
          host.insertAdjacentHTML("afterbegin", ringTemplate(idBase, "This Week’s Study Progress"));
          populateLegend(idBase);
        }
        var done = minutesThisWeek();
        updateDualRings(idBase, done, WEEKLY_TARGET);
      }

      document.addEventListener("DOMContentLoaded", function(){
        renderTodayBanner();
      });
      if (typeof window.renderToday === "function"){
        var __oldRT = window.renderToday;
        window.renderToday = function(){ try{ __oldRT.apply(this, arguments); }catch(e){} try{ renderTodayBanner(); }catch(e){} };
      }
      if (typeof window.renderSummary === "function"){
        var __oldRS = window.renderSummary;
        window.renderSummary = function(){ try{ __oldRS.apply(this, arguments); }catch(e){} try{ renderWeeklyBanner(); }catch(e){} };
      }
    })();
  </script>


  <!-- Popover module: standalone, safe, no dependency on internal functions -->
  <script>
    (function(){
      // Ensure popover node
      function ensurePopover(){
        var pop = document.getElementById("msaPop");
        if (!pop){
          pop = document.createElement("div");
          pop.id = "msaPop";
          pop.style.position = "fixed";
          pop.style.zIndex = "9999";
          pop.style.pointerEvents = "none";
          pop.style.background = "#111827";
          pop.style.color = "#fff";
          pop.style.padding = "8px 10px";
          pop.style.borderRadius = "8px";
          pop.style.fontSize = "12px";
          pop.style.boxShadow = "0 6px 20px rgba(0,0,0,0.2)";
          pop.style.opacity = "0";
          pop.style.transform = "translateY(-4px)";
          pop.style.transition = "opacity .15s, transform .15s";
          document.body.appendChild(pop);
        }
        return pop;
      }
      function showPop(){ var p=ensurePopover(); p.style.opacity="1"; p.style.transform="translateY(0)"; p.classList.add("show"); }
      function hidePop(){ var p=document.getElementById("msaPop"); if (p){ p.style.opacity="0"; p.style.transform="translateY(-4px)"; p.classList.remove("show"); } }

      // Local helpers (do not rely on app's closure)
      function toIsoLocal(d){ var z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
      function mondayOf(d){ var day=d.getDay(); var diff=(day===0?-6:(1-day)); var m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m; }
      function weekIsos(d){ var m=mondayOf(d), arr=[]; for(var i=0;i<7;i++){ var x=new Date(m); x.setDate(m.getDate()+i); arr.push(toIsoLocal(x)); } return arr; }
      function sumMins(list){ var n=0; for(var i=0;i<list.length;i++){ var a=list[i]; n += (a.duration|0) || (a.duration_min|0) || 0; } return n; }
      function minutesTodayBySubject(subjId){
        try{
          var iso = (typeof toIso==="function") ? toIso(new Date()) : toIsoLocal(new Date());
          var list = (window.state && state.days && state.days[iso] && state.days[iso].actuals) ? state.days[iso].actuals : [];
          var filtered = list.filter(function(a){ return a.subjectId===subjId; });
          return sumMins(filtered);
        }catch(e){ return 0; }
      }
      function minutesWeekBySubject(subjId){
        try{
          var isos = weekIsos(new Date());
          var tot = 0;
          for (var i=0;i<isos.length;i++){
            var iso = isos[i];
            var list = (window.state && state.days && state.days[iso] && state.days[iso].actuals) ? state.days[iso].actuals : [];
            var filtered = list.filter(function(a){ return a.subjectId===subjId; });
            tot += sumMins(filtered);
          }
          return tot;
        }catch(e){ return 0; }
      }
      function fmt(m){ m|=0; var h=(m/60)|0, mm=m%60; return h ? (h+"h "+(mm?mm+"m":"")) : (mm+" min"); }

      var activeChip = null;

      // Click to open
      document.addEventListener("click", function(e){
        var chip = e.target.closest && e.target.closest(".msa-chip");
        if (!chip){
          // outside click hides
          if (activeChip){
            var pop = document.getElementById("msaPop");
            if (pop && !e.target.closest("#msaPop")) hidePop();
            activeChip = null;
          }
          return;
        }
        activeChip = chip;
        var subj = chip.getAttribute("data-subj"); if (!subj) return;
        var todayM = minutesTodayBySubject(subj);
        var weekM  = minutesWeekBySubject(subj);
        var label  = chip.getAttribute("data-name") || chip.textContent.trim();

        var pop = ensurePopover();
        pop.innerHTML = '<div style="font-weight:700;margin-bottom:2px">'+label+'</div>'
                      + '<div>Today: '+fmt(todayM)+'</div>'
                      + '<div>This week: '+fmt(weekM)+'</div>';

        var rect = chip.getBoundingClientRect();
        var left = rect.left + rect.width/2 - 70; if (left < 8) left = 8;
        pop.style.left = left + "px";
        pop.style.top  = (rect.top + window.scrollY - 44) + "px";
        showPop();
      });

      // Pointer tracking: hide when pointer leaves the active chip area
      document.addEventListener("mousemove", function(e){
        if (!activeChip) return;
        var rect = activeChip.getBoundingClientRect();
        var x = e.clientX, y = e.clientY;
        var inside = (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
        if (!inside){
          var pop = document.getElementById("msaPop");
          if (!pop || !pop.contains(e.target)){ hidePop(); activeChip = null; }
        }
      });
      // Touch: any touch outside chip/popover hides
      document.addEventListener("touchstart", function(e){
        if (!activeChip) return;
        if (!e.target.closest(".msa-chip") && !e.target.closest("#msaPop")){ hidePop(); activeChip = null; }
      }, {passive:true});
    })();
  </script>


  <script>
  (function(){
    function z2(n){ return n<10?("0"+n):(""+n); }
    function isoOf(d){ var z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
    function mondayOf(d){ var day=d.getDay(); var diff=(day===0?-6:(1-day)); var m=new Date(d); m.setDate(d.getDate()+diff); m.setHours(0,0,0,0); return m; }
    function weekIsos(d){ var m=mondayOf(d), arr=[]; for(var i=0;i<7;i++){ var x=new Date(m); x.setDate(m.getDate()+i); arr.push((typeof toIso==="function")?toIso(x):isoOf(x)); } return arr; }
    function minutesToday(){
      var iso=(typeof toIso==="function")? toIso(new Date()): isoOf(new Date());
      var list=(window.state&&state.days&&state.days[iso]&&state.days[iso].actuals)? state.days[iso].actuals: [];
      var n=0; for(var i=0;i<list.length;i++){ var a=list[i]; n += (a.duration|0) || (a.duration_min|0) || 0; } return n;
    }
    function minutesThisWeek(){
      var isos=weekIsos(new Date()); var sum=0;
      for(var i=0;i<isos.length;i++){ var iso=isos[i];
        var list=(state&&state.days&&state.days[iso]&&state.days[iso].actuals)?state.days[iso].actuals:[];
        for(var j=0;j<list.length;j++){ var a=list[j]; sum += (a.duration|0)||(a.duration_min|0)||0; }
      } return sum;
    }
    function dailyTarget(d){ var n=d.getDay(); return (n===0||n===6)?360:240; } // min
    var WEEKLY_TARGET = 1920; // min
    function fmtHM(m){ m|=0; var h=(m/60)|0, mm=m%60; return (h? (h+'h') : '') + (mm? (h?' ':'')+mm+'m' : (!h?'0m':'')); }

    // Subject catalog from app if present
    var MSA_SUBJECTS=[];
    if (window.SUBJECT_MAP){
      for (var k in SUBJECT_MAP){ if(!SUBJECT_MAP.hasOwnProperty(k)) continue;
        var v=SUBJECT_MAP[k]||{}; MSA_SUBJECTS.push({id:k, name:v.name||k, emoji:v.emoji||""});
      }
    }

    function ringCard(idBase, title){
      return ''+
        '<section class="msa-card" id="'+idBase+'Card">'+
          '<div class="msa-left">'+
            '<div class="msa-ring-wrap">'+
              '<svg class="msa-ring" width="132" height="132">'+
                '<circle class="bg" cx="66" cy="66" r="56"></circle>'+
                '<circle class="fg" cx="66" cy="66" r="56" stroke-dasharray="351.86" stroke-dashoffset="351.86"></circle>'+
              '</svg>'+
              '<div class="msa-ring-center">'+
                '<div class="big" id="'+idBase+'Big">0%</div>'+
                '<div class="small" id="'+idBase+'Small">0 of 0h</div>'+
              '</div>'+
            '</div>'+
          '</div>'+
          '<div class="msa-right">'+
            '<div class="label">'+title+'</div>'+
            '<div class="msa-linear"><span id="'+idBase+'Linear"></span></div>'+
            '<div class="msa-legend" id="'+idBase+'Legend"></div>'+
          '</div>'+
        '</section>';
    }

    function setRing(root, percent, doneMin, targetMin){
      var r=56, circ=2*Math.PI*r, offset=circ*(1-Math.max(0,Math.min(1,percent)));
      var fg=root.querySelector(".msa-ring .fg"); if(fg){ fg.setAttribute("stroke-dasharray", String(circ.toFixed(2))); fg.setAttribute("stroke-dashoffset", String(offset.toFixed(2))); fg.setAttribute("stroke", percent>=1? "#10b981" : "#3b82f6"); }
      var big=root.querySelector(".msa-ring-center .big"); if (big) big.textContent = Math.round(percent*100)+"%";
      var small=root.querySelector(".msa-ring-center .small"); if (small) small.textContent = fmtHM(doneMin)+" of "+(targetMin/60)+"h";
      var lin=root.querySelector(".msa-linear>span"); if (lin) lin.style.width=Math.round(percent*100)+"%";
    }

    function populateLegend(prefix){
      var host=document.getElementById(prefix+"Legend"); if(!host) return;
      host.innerHTML="";
      (MSA_SUBJECTS||[]).forEach(function(s){
        var chip=document.createElement("div");
        chip.className="msa-chip"; chip.setAttribute("data-subj", s.id); chip.setAttribute("data-name", s.name||s.id);
        var emo=document.createElement("span"); emo.className="emo"; emo.textContent=s.emoji||"";
        var name=document.createElement("span"); name.textContent=s.name||s.id;
        chip.appendChild(emo); chip.appendChild(name);
        host.appendChild(chip);
      });
    }

    function removeExistingCards(){
      var a=document.getElementById("todayCard"); if(a && a.parentNode) a.parentNode.removeChild(a);
      var b=document.getElementById("weeklyCard"); if(b && b.parentNode) b.parentNode.removeChild(b);
    }

    function renderTodayBanner(){
      var host=document.getElementById("screen-today"); if(!host) return;
      if (!document.getElementById("todayCard")){
        host.insertAdjacentHTML("afterbegin", ringCard("today", "Today’s Study Progress"));
        populateLegend("today");
      }
      var now=new Date(); var tgt=dailyTarget(now); var done=minutesToday();
      setRing(document.getElementById("todayCard"), tgt? (done/tgt):0, done, tgt);
    }

    function renderWeeklyBanner(){
      var host=document.getElementById("screen-summary"); if(!host) return;
      if (!document.getElementById("weeklyCard")){
        host.insertAdjacentHTML("afterbegin", ringCard("weekly", "This Week’s Study Progress"));
        populateLegend("weekly");
      }
      var done=minutesThisWeek();
      setRing(document.getElementById("weeklyCard"), WEEKLY_TARGET? (done/WEEKLY_TARGET):0, done, WEEKLY_TARGET);
    }

    // Hook into app renders
    document.addEventListener("DOMContentLoaded", function(){
      removeExistingCards();
      renderTodayBanner();
    });
    if (typeof window.renderToday === "function"){
      var __oldRT = window.renderToday;
      window.renderToday = function(){ try{ __oldRT.apply(this, arguments);}catch(e){} try{ removeExistingCards(); renderTodayBanner(); }catch(e){} };
    }
    if (typeof window.renderSummary === "function"){
      var __oldRS = window.renderSummary;
      window.renderSummary = function(){ try{ __oldRS.apply(this, arguments);}catch(e){} try{ removeExistingCards(); renderWeeklyBanner(); }catch(e){} };
    }
  })();
  </script>


<script>
(function(){
  // --- Helpers (reuse those already defined by v11 if present) ---
  function fmtHM(m){ m|=0; var h=(m/60)|0, mm=m%60; return (h? (h+'h') : '') + (mm? (h?' ':'')+mm+'m' : (!h?'0m':'')); }
  function isoOf(d){ var z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
  function mondayOf(d){ var day=d.getDay(); var diff=(day===0?-6:(1-day)); var m=new Date(d); m.setDate(m.getDate()+diff); m.setHours(0,0,0,0); return m; }
  function weekIsos(d){ var m=mondayOf(d), arr=[]; for(var i=0;i<7;i++){ var x=new Date(m); x.setDate(m.getDate()+i); arr.push((typeof toIso==="function")?toIso(x):isoOf(x)); } return arr; }
  function minutesToday(){
    var iso=(typeof toIso==="function")? toIso(new Date()): isoOf(new Date());
    var list=(window.state&&state.days&&state.days[iso]&&state.days[iso].actuals)? state.days[iso].actuals: [];
    var n=0; for(var i=0;i<list.length;i++){ var a=list[i]; n += (a.duration|0) || (a.duration_min|0) || 0; } return n;
  }
  function minutesThisWeek(){
    var isos=weekIsos(new Date()); var sum=0;
    for(var i=0;i<isos.length;i++){ var iso=isos[i];
      var list=(state&&state.days&&state.days[iso]&&state.days[iso].actuals)?state.days[iso].actuals:[];
      for(var j=0;j<list.length;j++){ var a=list[j]; sum += (a.duration|0)||(a.duration_min|0)||0; }
    } return sum;
  }
  function dailyTarget(d){ var n=d.getDay(); return (n===0||n===6)?360:240; }
  var WEEKLY_TARGET = 1920;

  function ringHTML(prefix, title){
    return ''+
      '<section class="msa-card" id="'+prefix+'Card">'+
        '<div class="msa-left">'+
          '<div class="msa-ring-wrap">'+
            '<svg class="msa-ring" width="132" height="132">'+
              '<circle class="bg" cx="66" cy="66" r="56"></circle>'+
              '<circle class="fg" cx="66" cy="66" r="56" stroke-dasharray="351.86" stroke-dashoffset="351.86"></circle>'+
            '</svg>'+
            '<div class="msa-ring-center">'+
              '<div class="big" id="'+prefix+'Big">0%</div>'+
              '<div class="small" id="'+prefix+'Small">0 of 0h</div>'+
            '</div>'+
          '</div>'+
        '</div>'+
        '<div class="msa-right">'+
          '<div class="label">'+title+'</div>'+
          '<div class="msa-linear"><span id="'+prefix+'Linear"></span></div>'+
          '<div class="msa-legend" id="'+prefix+'Legend"></div>'+
        '</div>'+
      '</section>';
  }

  function ensureCard(prefix){
    var host = document.getElementById(prefix==="today" ? "screen-today" : "screen-summary");
    if (!host) return null;
    var card = document.getElementById(prefix+"Card");
    if (!card){
      var title = (prefix==="today") ? "Today’s Study Progress" : "This Week’s Study Progress";
      host.insertAdjacentHTML("afterbegin", ringHTML(prefix, title));
      // fill legend once
      try {
        var M = [];
        if (window.SUBJECT_MAP){
          for (var k in SUBJECT_MAP){ if(!SUBJECT_MAP.hasOwnProperty(k)) continue;
            var v=SUBJECT_MAP[k]||{}; M.push({id:k, name:v.name||k, emoji:v.emoji||""});
          }
        }
        var legend = document.getElementById(prefix+"Legend");
        if (legend){
          legend.innerHTML = "";
          (M||[]).forEach(function(s){
            var chip=document.createElement("div"); chip.className="msa-chip";
            chip.setAttribute("data-subj", s.id); chip.setAttribute("data-name", s.name||s.id);
            var emo=document.createElement("span"); emo.className="emo"; emo.textContent=s.emoji||"";
            var name=document.createElement("span"); name.textContent=s.name||s.id;
            chip.appendChild(emo); chip.appendChild(name); legend.appendChild(chip);
          });
        }
      }catch(e){}
      card = document.getElementById(prefix+"Card");
    }
    return card;
  }

  function updateCard(prefix){
    var card = ensureCard(prefix); if (!card) return;
    var done = (prefix==="today") ? minutesToday() : minutesThisWeek();
    var tgt  = (prefix==="today") ? dailyTarget(new Date()) : WEEKLY_TARGET;
    var percent = tgt ? (done/tgt) : 0;
    var r=56, circ=2*Math.PI*r, offset=circ*(1-Math.max(0,Math.min(1,percent)));
    var fg=card.querySelector(".msa-ring .fg"); if(fg){ fg.setAttribute("stroke-dasharray", String(circ.toFixed(2))); fg.setAttribute("stroke-dashoffset", String(offset.toFixed(2))); fg.setAttribute("stroke", percent>=1? "#10b981" : "#3b82f6"); }
    var big=card.querySelector(".msa-ring-center .big"); if (big) big.textContent = Math.round(percent*100)+"%";
    var small=card.querySelector(".msa-ring-center .small"); if (small) small.textContent = fmtHM(done)+" of "+(tgt/60)+"h";
    var lin=card.querySelector(".msa-linear>span"); if (lin) lin.style.width=Math.round(percent*100)+"%";
  }

  function observeAndMaintain(prefix){
    var containerId = (prefix==="today")?"screen-today":"screen-summary";
    var container = document.getElementById(containerId);
    if (!container) return;
    var obs = new MutationObserver(function(muts){
      // If our card was removed during a render, re-add and update
      if (!document.getElementById(prefix+"Card")){
        ensureCard(prefix);
      }
      updateCard(prefix);
    });
    obs.observe(container, { childList:true, subtree:false });
    // Initial update
    ensureCard(prefix); updateCard(prefix);
  }

  // Run once ready
  document.addEventListener("DOMContentLoaded", function(){
    observeAndMaintain("today");
    observeAndMaintain("weekly");
  });

  // Also hook common app render points if present
  if (typeof window.renderToday === "function"){
    var __rt = window.renderToday;
    window.renderToday = function(){ try{ __rt.apply(this, arguments);}catch(e){} try{ updateCard("today"); }catch(e){} };
  }
  if (typeof window.renderSummary === "function"){
    var __rs = window.renderSummary;
    window.renderSummary = function(){ try{ __rs.apply(this, arguments);}catch(e){} try{ updateCard("weekly"); }catch(e){} };
  }
})();
</script>

<script src="log-actual.js?v=2"></script>

<script>
(function(){
  function ready(fn){ document.readyState!='loading' ? fn() : document.addEventListener('DOMContentLoaded',fn); }
  ready(function(){
    if (!window.logActual) return; // waits until helper is present

    // Wrap existing "Done" functions so we always hit the DB, regardless of older code paths.
    const safeWrap = (fnName) => {
      const orig = window[fnName];
      if (typeof orig !== 'function') return;

      window[fnName] = function(...args){
        try {
          const ret = orig.apply(this, args);
          // Try to infer the session data and call logActual as a safety net.
          setTimeout(() => {
            try {
              if (typeof toIso !== 'function' || !window.todayDate || !window.state) return;
              const iso = toIso(todayDate);
              const d = (state.days && state.days[iso]) || {};
              const last = (d.actuals || [])[ (d.actuals||[]).length - 1 ];
              if (!last) return;
              // Build a payload from the latest actual
              const pm = (t)=>{ try { return parseM(t); } catch { return null; } };
              const s = pm(last.startActual), e = pm(last.endActual);
              const payload = (s!=null && e!=null)
                ? { subjectId: last.subjectId, startMin: s, endMin: e, iso }
                : { subjectId: last.subjectId, durationMin: Math.floor(Number(last.duration || 0)), iso };
              window.logActual(payload).catch(console.warn);
            } catch (e) { console.warn(e); }
          }, 50);
          return ret;
        } catch (e) {
          console.error(e);
          throw e;
        }
      };
    };

    safeWrap('markDoneTodaySelf');
    safeWrap('markDoneTodayTuition');
  });
})();
</script>


</body>
</html>
